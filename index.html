<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Huckey’s Adventure — v15 (final)</title>
<style>
  html,body{margin:0;height:100%;background:#f6f7fb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;touch-action:manipulation;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}
  #container{position:relative;width:100vw;height:100vh;overflow:hidden;background:linear-gradient(#cfe7ff,#f6f7fb)}
  canvas{display:block;width:100%;height:100%}
  .ui{position:absolute;inset:0;pointer-events:none;color:#222;text-shadow:0 1px 0 rgba(255,255,255,.6)}
  .hudLeft{position:absolute;left:16px;top:12px;display:flex;align-items:center;gap:8px;font-weight:700}
  .hudRight{position:absolute;right:16px;top:12px;display:flex;gap:8px;align-items:center}
  .score{font-size:18px;padding-left:6px}
  .mult{font-size:14px;padding:2px 6px;border-radius:8px;background:rgba(255,255,255,.7);border:1px solid #d9e4ff}
  .mult.star{box-shadow:0 0 10px rgba(255,215,0,.6)}
  .mult.bump{animation:bump .22s ease-out}
  @keyframes bump{0%{transform:scale(1)}50%{transform:scale(1.18)}100%{transform:scale(1)}}
  .hearts{display:grid;grid-auto-flow:column;grid-gap:6px}
  .heartSlot{width:26px;height:24px;position:relative}
  .heartFull,.heartEmpty{width:100%;height:100%;display:block}
  .heartEmpty{opacity:.55}
  .heartPop{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;animation:heartPop .65s ease-out forwards}
  @keyframes heartPop{0%{transform:translateY(0) scale(1);opacity:1}40%{transform:translateY(-6px) scale(1.25);opacity:1}100%{transform:translateY(-22px) scale(.65);opacity:0}}
  .titleCard,.gameOverCard{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.9);border-radius:12px;padding:18px 22px;box-shadow:0 8px 24px rgba(0,0,0,.15);text-align:center;pointer-events:auto}
  .titleCard h1{margin:0 0 10px 0;font-size:clamp(32px,5.5vw,56px);color:#ff4f93;line-height:1.05}
  .btn{display:inline-block;margin-top:12px;padding:10px 16px;background:#4f8bff;color:#fff;border-radius:10px;font-weight:700;cursor:pointer;border:none;pointer-events:auto}
  .btn:active{transform:translateY(1px)}
  .settingsBtn{position:absolute;top:10px;left:50%;transform:translateX(-50%);pointer-events:auto;background:#fff;border:1px solid #cfe1ff;border-radius:999px;padding:6px 10px;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,.08);cursor:pointer}
  .settingsPanel{position:absolute;top:42px;left:50%;transform:translateX(-50%);pointer-events:auto;background:rgba(255,255,255,.96);border:1px solid #cfe1ff;border-radius:12px;padding:10px 12px;box-shadow:0 8px 20px rgba(0,0,0,.12);font-size:14px;display:none;min-width:280px}
  .settingsRow{display:flex;align-items:center;gap:10px;margin:6px 0}
  .toggle{appearance:none;width:36px;height:20px;background:#c8d7ff;border-radius:999px;position:relative;outline:none;cursor:pointer}
  .toggle:checked{background:#4f8bff}
  .toggle::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;background:#fff;border-radius:50%;transition:left .15s}
  .toggle:checked::after{left:18px}
  .mobileControls{position:absolute;left:0;right:0;bottom:0;height:34%;display:flex;gap:12px;justify-content:space-between;align-items:center;padding:18px;pointer-events:none;background:linear-gradient(180deg,rgba(246,247,251,0) 0%,rgba(246,247,251,.85) 18%,rgba(246,247,251,.95) 100%)}
  .mobileBtn{width:44%;height:70%;border-radius:16px;background:#fff;border:2px solid #cfe1ff;box-shadow:0 6px 16px rgba(0,0,0,.08);pointer-events:auto;display:flex;align-items:center;justify-content:center;font-size:min(6vw,28px);font-weight:800;color:#4f8bff;user-select:none}
  .mobileBtn:active{transform:scale(.98)}
  .pauseBadge{position:absolute;left:50%;top:50%;transform:translate(-50%,-120%);background:rgba(0,0,0,.55);color:#fff;padding:6px 10px;border-radius:8px;font-weight:700;display:none}
  .pauseBadge.show{display:block}
  .points{position:absolute;left:0;top:0;pointer-events:none}
  .banner{position:absolute;top:72px;left:50%;transform:translateX(-50%);padding:8px 14px;border-radius:12px;color:#fff;font-weight:800;letter-spacing:.3px;box-shadow:0 6px 16px rgba(0,0,0,.18);display:none;pointer-events:none}
</style>
</head>
<body>
<div id="container">
  <canvas id="game"></canvas>
  <div class="ui">
    <div class="hudLeft"><div class="score" id="score">0</div><div class="mult" id="mult">×1</div></div>
    <div class="hudRight"><div class="hearts" id="hearts"></div></div>
    <button class="settingsBtn" id="settingsBtn">⚙︎ Settings / Pause</button>
    <div class="settingsPanel" id="settingsPanel">
      <div class="settingsRow"><label>Music</label><input type="checkbox" id="musicToggle" class="toggle" checked/></div>
      <div class="settingsRow"><label>SFX</label><input type="checkbox" id="sfxToggle" class="toggle" checked/></div>
      <div class="settingsRow"><label>Show +points</label><input type="checkbox" id="pointsToggle" class="toggle" checked/></div>
      <div style="font-size:12px;opacity:.8;margin-top:6px">Endless runner • Collect carrots • Grab ★ for invincibility • ❤ restores a life</div>
    </div>
    <div class="titleCard" id="title"><h1>Huckey’s Adventure</h1><p>Endless runner • Bunny City</p><button class="btn" id="startBtn">Start</button></div>
    <div class="gameOverCard" id="gameOver" style="display:none;"><h2 style="margin:0 0 8px 0;">Huckey fainted!</h2><div style="margin:6px 0;">Score: <span id="finalScore">0</span></div><button class="btn" id="restartBtn">Try Again</button></div>
    <div class="mobileControls" id="mobileControls" style="display:none;"><div class="mobileBtn" id="jumpBtn">JUMP</div><div class="mobileBtn" id="slideBtn">SLIDE</div></div>
    <div class="pauseBadge" id="pauseBadge"></div>
    <div class="points" id="pointsLayer"></div>
    <div class="banner" id="banner"></div>
  </div>
</div>
<script>
(()=>{
  const canvas = document.getElementById('game'); const ctx = canvas.getContext('2d');
  function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; } addEventListener('resize',resize); resize();

  // UI
  const heartsEl = document.getElementById('hearts'), scoreEl=document.getElementById('score'), multEl=document.getElementById('mult');
  const titleCard=document.getElementById('title'), startBtn=document.getElementById('startBtn');
  const gameOverCard=document.getElementById('gameOver'), finalScoreEl=document.getElementById('finalScore'), restartBtn=document.getElementById('restartBtn');
  const settingsBtn=document.getElementById('settingsBtn'), settingsPanel=document.getElementById('settingsPanel');
  const musicToggle=document.getElementById('musicToggle'), sfxToggle=document.getElementById('sfxToggle'), pointsToggle=document.getElementById('pointsToggle');
  const pauseBadge=document.getElementById('pauseBadge'), pointsLayer=document.getElementById('pointsLayer'), banner=document.getElementById('banner');
  const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const mobileControls=document.getElementById('mobileControls'), jumpBtn=document.getElementById('jumpBtn'), slideBtn=document.getElementById('slideBtn'); if(isMobile) mobileControls.style.display='flex';

  // Audio
  let audioCtx=null; let musicEnabled=true, sfxEnabled=true; let showPoints=true;
  musicToggle.onchange=()=>{ musicEnabled=musicToggle.checked; if(musicEnabled) setMusicMode('normal'); else stopAllMusic(); };
  sfxToggle.onchange=()=>{ sfxEnabled=sfxToggle.checked; }; pointsToggle.onchange=()=>{ showPoints=pointsToggle.checked; };
  function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
  function envPlay(type, f0, f1, ms, gainMax=0.15, dest=null){ ensureAudio(); const t0=audioCtx.currentTime; const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
    const out=dest||audioCtx.destination; o.type=type; o.frequency.setValueAtTime(f0,t0); const t1=t0+ms/1000; if(f1&&f1>0) o.frequency.exponentialRampToValueAtTime(Math.max(20,f1),t1);
    g.gain.setValueAtTime(0.0001,t0); g.gain.exponentialRampToValueAtTime(gainMax,t0+.02); g.gain.exponentialRampToValueAtTime(0.0001,t1); o.connect(g).connect(out); o.start(t0); o.stop(t1+.02); }
  function noise(ms=250, gainMax=.2, dest=null){ ensureAudio(); const n=audioCtx.createBuffer(1,audioCtx.sampleRate*(ms/1000),audioCtx.sampleRate); const d=n.getChannelData(0);
    for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*(1-i/d.length); const s=audioCtx.createBufferSource(); s.buffer=n; const g=audioCtx.createGain(); g.gain.value=gainMax;
    const out=dest||audioCtx.destination; const f=audioCtx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=1200; s.connect(f).connect(g).connect(out); const t0=audioCtx.currentTime; s.start(t0); s.stop(t0+ms/1000); }
  const musicGain=()=>{ ensureAudio(); if(!musicGain.node){ musicGain.node=audioCtx.createGain(); musicGain.node.gain.value=.9; musicGain.node.connect(audioCtx.destination);} return musicGain.node; };
  const sfxGain=()=>{ ensureAudio(); if(!sfxGain.node){ sfxGain.node=audioCtx.createGain(); sfxGain.node.gain.value=1.0; sfxGain.node.connect(audioCtx.destination);} return sfxGain.node; };
  const sfx={slide:()=>{ if(!sfxEnabled) return; envPlay('sawtooth',800,200,200,.1,sfxGain()); },
             star:()=>{ if(!sfxEnabled) return; envPlay('sine',700,1600,160,.12,sfxGain()); setTimeout(()=>envPlay('sine',900,2200,180,.1,sfxGain()),120); },
             heart:()=>{ if(!sfxEnabled) return; envPlay('triangle',600,900,180,.12,sfxGain()); },
             puff:()=>{ if(!sfxEnabled) return; noise(240,.16,sfxGain()); envPlay('triangle',220,120,160,.05,sfxGain()); },
             hit:()=>{ if(!sfxEnabled) return; envPlay('square',220,100,180,.12,sfxGain()); noise(100,.1,sfxGain()); },
             jump:()=>{ if(!sfxEnabled) return; envPlay('sine',350,1000,160,.1,sfxGain()); },
             gameover:()=>{ if(!sfxEnabled) return; envPlay('sawtooth',330,180,320,.12,sfxGain()); setTimeout(()=>envPlay('triangle',262,120,420,.10,sfxGain()),260); } };

  // Music
  let normalTimer=null, starTimer=null; let musicMode='stopped';
  function stopAllMusic(){ if(normalTimer){clearInterval(normalTimer);normalTimer=null;} if(starTimer){clearInterval(starTimer);starTimer=null;} musicMode='stopped'; }
  function setMusicMode(mode){ if(!musicEnabled) return; if(musicMode===mode) return; if(normalTimer){clearInterval(normalTimer);normalTimer=null;} if(starTimer){clearInterval(starTimer);starTimer=null;} musicMode=mode;
    if(mode==='normal') startNormal(); else if(mode==='star') startStar(); }
  function startNormal(){ const chords=[[261.63,329.63,392],[196,246.94,392],[220,261.63,329.63],[174.61,220,349.23],[261.63,329.63,392],[196,246.94,392],[220,261.63,329.63],[174.61,220,349.23]]; let step=0;
    normalTimer=setInterval(()=>{ if(!musicEnabled||musicMode!=='normal') return; const bar=Math.floor(step/8)%chords.length; const ch=chords[bar]; const i=step%8; const note=ch[i%ch.length]*(i===7?2:1);
      envPlay('triangle',note,note*1.01,200,.05,musicGain()); if(i===2||i===6) envPlay('sine',ch[0]/2,ch[0]/2,160,.03,musicGain()); step++; },170); }
  function startStar(){ const scale=[523.25,587.33,659.25,783.99]; let i=0; starTimer=setInterval(()=>{ if(!musicEnabled||musicMode!=='star') return;
      const f=scale[i%scale.length]*(i%4===3?2:1); envPlay('square',f,f*1.02,140,.06,musicGain()); if(i%2===0) envPlay('sine',f/2,f/2,120,.03,musicGain()); i++; },130); }

  // Constants
  const GRAVITY=2200, JUMP_VEL=-900, MAX_DOUBLE=1;
  const BASE_SPEED=380, SPEED_RAMP_STEP=45, SPEED_RAMP_INTERVAL=20000;
  const SPAWN_BASE=1200, SPAWN_MIN=650;
  const STAR_CHANCE=0.06, HEART_CHANCE=0.025, STAR_DURATION=10000, DMG_INV=1200;
  const STAND_H=100, SLIDE_H=Math.floor(STAND_H*0.62);

  // Difficulty knobs
  function timePhase(s){ if(s<30) return 0; if(s<60) return 1; if(s<90) return 2; if(s<120) return 3; if(s<180) return 4; return 5; }
  const phaseParams=[
    {combo:0.03, slideOnly:0.10, spacing:[8,10], speedMul:1.0},
    {combo:0.08, slideOnly:0.20, spacing:[7,9],  speedMul:1.1},
    {combo:0.14, slideOnly:0.25, spacing:[6,8],  speedMul:1.2},
    {combo:0.18, slideOnly:0.30, spacing:[6,7],  speedMul:1.3},
    {combo:0.22, slideOnly:0.35, spacing:[5,6],  speedMul:1.4},
    {combo:0.26, slideOnly:0.40, spacing:[4,5],  speedMul:1.5}
  ];

  // State
  let gameState='title', transitioning=false;
  let last=0, elapsed=0, worldSpeed=BASE_SPEED, spawnTimer=0, spawnInterval=SPAWN_BASE, score=0;
  const obstacles=[], carrotItems=[], stars=[], hearts=[], particles=[], floatTexts=[], decorItems=[];

  // Player
  const player={ x:()=>canvas.width*.2, y:0, vy:0, width:72, height:STAND_H, onGround:false, dJumps:MAX_DOUBLE, hearts:3,
                 starUntil:0, dmgInvUntil:0, slideHeld:false, sliding:false, prevSliding:false, fainting:false, faintT:0, runPhase:0, hue:0 };
  function groundY(){ return Math.floor(canvas.height*.78); }
  let carrotStreak=0; function baseMult(){ return Math.min(5,1+Math.floor(carrotStreak/5)); }
  function currentMult(){ const m=baseMult(); return (performance.now()<player.starUntil)? Math.min(8,m*2): m; }  /* x8 cap during star */
  function updateMultUI(bump=false){ const m=currentMult(); multEl.textContent='×'+m; if(performance.now()<player.starUntil) multEl.classList.add('star'); else multEl.classList.remove('star'); if(bump){ multEl.classList.remove('bump'); void multEl.offsetWidth; multEl.classList.add('bump'); }}

  // Pause/settings
  function openSettings(){ if(gameState!=='running'||transitioning) return; settingsPanel.style.display='block'; setPause(true); }
  function closeSettings(){ settingsPanel.style.display='none'; setPause(false); }
  settingsBtn.onclick=()=>{ if(gameState==='title'||gameState==='over'||transitioning) return; if(gameState!=='paused') openSettings(); else closeSettings(); };
  addEventListener('keydown',e=>{
    if(e.key==='p'||e.key==='P'){ if(transitioning||gameState==='title'||gameState==='over') return; if(gameState!=='paused') openSettings(); else closeSettings(); return; }
    if(gameState!=='running'||transitioning) return;
    if(e.key==='ArrowUp'||e.key==='w'||e.key===' ') jump();
    if(e.key==='ArrowDown'||e.key==='s'){ player.slideHeld=true; if(sfxEnabled) sfx.slide(); }
  });
  addEventListener('keyup',e=>{ if(e.key==='ArrowDown'||e.key==='s') player.slideHeld=false; });
  function bindPress(el,down,up){ const d=ev=>{ev.preventDefault(); if(gameState==='running'&&!transitioning) down();}; const u=ev=>{ev.preventDefault(); if(gameState==='running'&&!transitioning&&up) up();};
    el.addEventListener('touchstart',d,{passive:false}); el.addEventListener('touchend',u,{passive:false}); el.addEventListener('mousedown',d); el.addEventListener('mouseup',u); el.addEventListener('mouseleave',u); }
  bindPress(jumpBtn,()=>jump()); bindPress(slideBtn,()=>{player.slideHeld=true; if(sfxEnabled) sfx.slide();},()=>{player.slideHeld=false;});

  function setPause(v){ if(v){ if(gameState==='running'){ gameState='paused'; pauseBadge.classList.add('show'); pauseBadge.textContent=isMobile?'Paused':'Paused — Press P to resume'; } }
                        else{ if(gameState==='paused'){ gameState='running'; pauseBadge.classList.remove('show'); } } }

  // Hearts HUD
  function heartSVG(full=true){
    if(full) return `<svg class="heartFull" viewBox="0 0 64 60" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#ff6aa5"/><stop offset="100%" stop-color="#ff3d88"/></linearGradient></defs><path d="M32 56 C 12 40, 4 30, 4 20 C 4 10, 12 4, 20 4 C 26 4, 30 7, 32 11 C 34 7, 38 4, 44 4 C 52 4, 60 10, 60 20 C 60 30, 52 40, 32 56 Z" fill="url(#g)" stroke="#c22668" stroke-width="3"/><path d="M22 12 C 18 10, 14 12, 13 16" fill="none" stroke="rgba(255,255,255,.7)" stroke-width="4" stroke-linecap="round"/><path d="M33 49 C 30 52, 28 53, 26 54" fill="none" stroke="rgba(0,0,0,.08)" stroke-width="4" stroke-linecap="round"/></svg>`;
    return `<svg class="heartEmpty" viewBox="0 0 64 60" xmlns="http://www.w3.org/2000/svg"><path d="M32 56 C 12 40, 4 30, 4 20 C 4 10, 12 4, 20 4 C 26 4, 30 7, 32 11 C 34 7, 38 4, 44 4 C 52 4, 60 10, 60 20 C 60 30, 52 40, 32 56 Z" fill="rgba(255,255,255,.12)" stroke="#9aa1aa" stroke-width="3"/></svg>`;
  }
  function updateHearts(){ heartsEl.innerHTML=''; for(let i=0;i<3;i++){ const slot=document.createElement('div'); slot.className='heartSlot'; const isFull=i<player.hearts; slot.innerHTML=heartSVG(isFull); heartsEl.appendChild(slot);} }
  function heartPopEffect(){ const idx=Math.max(0,player.hearts-1); const slot=heartsEl.children[idx]; if(!slot) return; const pop=document.createElement('div'); pop.className='heartPop'; pop.innerHTML=heartSVG(true); slot.appendChild(pop);
    hudSparkleBurst(slot.getBoundingClientRect()); setTimeout(()=>{ if(pop.parentNode) pop.parentNode.removeChild(pop); },700);
  }
  function hudSparkleBurst(rect){ const n=12; for(let i=0;i<n;i++){ const ang=Math.PI*2*Math.random(); const sp=40+Math.random()*80; particles.push({type:'hudSpark', x:rect.left+rect.width/2, y:rect.top+rect.height/2, vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp, life:.45, t:0}); } }

  // Game control
  function resetGame(){
    obstacles.length=carrotItems.length=stars.length=hearts.length=particles.length=floatTexts.length=decorItems.length=0;
    worldSpeed=BASE_SPEED; spawnInterval=SPAWN_BASE; spawnTimer=0; elapsed=0; score=0; carrotStreak=0;
    player.y=groundY()-player.height; player.vy=0; player.onGround=true; player.dJumps=MAX_DOUBLE; player.hearts=3; player.starUntil=0; player.dmgInvUntil=0;
    player.slideHeld=false; player.sliding=false; player.prevSliding=false; player.fainting=false; player.faintT=0; player.runPhase=0; transitioning=false;
    updateHearts(); scoreEl.textContent='0'; updateMultUI(); settingsPanel.style.display='none'; pauseBadge.classList.remove('show');
    scheduleNextEvent();
  }
  function startGame(){ resetGame(); titleCard.style.display='none'; gameOverCard.style.display='none'; ensureAudio(); if(musicEnabled) setMusicMode('normal'); gameState='running'; }
  startBtn.onclick=startGame; restartBtn.onclick=startGame;

  function jump(){ if(player.fainting||transitioning) return; ensureAudio(); if(player.onGround){ player.vy=JUMP_VEL; player.onGround=false; player.dJumps=MAX_DOUBLE; if(sfxEnabled) sfx.jump(); }
                   else if(player.dJumps>0){ player.vy=JUMP_VEL*.92; player.dJumps--; if(sfxEnabled) sfx.jump(); } }

  // Math helpers
  function aabb(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
  function rr(x,y,w,h,r,fill,stroke){ const R=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+R,y); ctx.arcTo(x+w,y,x+w,y+h,R); ctx.arcTo(x+w,y+h,x,y+h,R); ctx.arcTo(x,y+h,x,y,R); ctx.arcTo(x,y,x+w,y,R);
    if(fill){ ctx.fillStyle=fill; ctx.fill(); } if(stroke){ ctx.strokeStyle=stroke; ctx.lineWidth=2; ctx.stroke(); } }

  // Parallax background
  const parallax=[]; function makeLayer(tileW,color,bYf,hF,step,winAlpha){ const off=document.createElement('canvas'); off.width=tileW; off.height=1000; const o=off.getContext('2d'); const h=off.height;
    const baseY=Math.floor(h*bYf), layerH=Math.floor(h*hF), cols=Math.floor(tileW/step);
    for(let i=0;i<cols;i++){ const x=i*step+10, bw=step-20, t=(i*37)%97, bh=Math.floor(layerH*(0.55+(t%10)/50));
      o.fillStyle=color; o.fillRect(x,baseY-bh,bw,bh); o.fillStyle=`rgba(255,255,255,${winAlpha})`; for(let wx=6;wx<bw;wx+=18){ for(let wy=6;wy<bh;wy+=18){ o.fillRect(x+wx,baseY-bh+wy,8,8); } } }
    return {canvas:off, baseY}; }
  function initParallax(){ parallax.length=0; const w=800;
    parallax.push({speed:.15, layer:makeLayer(w,'#b7d2ff',.62,.25,200,.12), step:w, offset:0});
    parallax.push({speed:.30, layer:makeLayer(w,'#98c0ff',.68,.28,180,.14), step:w, offset:0});
    parallax.push({speed:.55, layer:makeLayer(w,'#7fb0ff',.74,.32,160,.16), step:w, offset:0}); }
  initParallax(); addEventListener('resize',initParallax);

  // Decorative props (non-collidable)
  function spawnDecor(){ const gY=groundY(); const which=['hydrant','cone','bench','cart','newsbox'][Math.floor(Math.random()*5)];
    const y = gY - (which==='bench'?60: which==='newsbox'?70: which==='cart'?56: 44) - 22; const w=canvas.width;
    decorItems.push({type:which, x:w+60+Math.random()*100, y}); if(decorItems.length>16) decorItems.shift();
  }
  let decorTimer=0;
  function drawDecor(dt){ decorTimer += dt*1000; if(decorTimer>800){ decorTimer=0; if(Math.random()<0.7) spawnDecor(); }
    for(let i=decorItems.length-1;i>=0;i--){ const d=decorItems[i]; d.x -= worldSpeed*0.55*dt; // parallax speed
      ctx.save(); ctx.globalAlpha=.85; // subtle, desaturated look
      if(d.type==='hydrant'){ rr(d.x,d.y,20,38,6,'#e2a8a8','#c58c8c'); }
      if(d.type==='cone'){ rr(d.x,d.y,18,18,6,'#f1c19a','#d2a182'); }
      if(d.type==='bench'){ rr(d.x,d.y,64,44,8,'#d9d0b8','#b3a88e'); }
      if(d.type==='cart'){ rr(d.x,d.y,70,50,10,'#e8cfe0','#c3aab8'); }
      if(d.type==='newsbox'){ rr(d.x,d.y,34,58,6,'#c4d2ee','#9eb5dc'); }
      ctx.restore();
      if(d.x<-120) decorItems.splice(i,1);
    }
  }

  // Obstacles drawing (chunky/cartoon)
  function drawObstacle(o){
    if(o.type==='block'){ rr(o.x,o.y,o.w,o.h,10,'#5e7fd8','#2c49a4'); }
    if(o.type==='car'){ rr(o.x,o.y,o.w,o.h,10,'#6aa5ff','#2b5bb8'); ctx.fillStyle='#333'; ctx.beginPath(); ctx.arc(o.x+22,o.y+o.h,12,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(o.x+o.w-22,o.y+o.h,12,0,Math.PI*2); ctx.fill(); }
    if(o.type==='van'){ rr(o.x,o.y,o.w,o.h,10,'#7eafff','#2b5bb8'); }
    if(o.type==='truck'){ rr(o.x,o.y,o.w,o.h,10,'#6aa5ff','#2b5bb8'); rr(o.x+10,o.y+10,60,20,6,'#ffd34f','#caa12e'); }
    if(o.type==='post'){ rr(o.x+o.w*.35,o.y,o.w*.30,o.h,8,'#4f6aa8','#2a3f6e'); rr(o.x,o.y-10,o.w,14,6,'#4f6aa8','#2a3f6e'); }
    if(o.type==='sign'){ rr(o.x,o.y,o.w,o.h,6,'#8a7cff','#5a49cc'); }
    if(o.type==='gantry'){ rr(o.x,o.y,o.w,o.h,6,'#ffd34f','#caa12e'); ctx.strokeStyle='#c28f25'; for(let sx=o.x;sx<o.x+o.w;sx+=18){ ctx.beginPath(); ctx.moveTo(sx,o.y); ctx.lineTo(sx+12,o.y+o.h); ctx.stroke(); } }
    if(o.type==='bus'){ rr(o.x,o.y,o.w,o.h,6,'#4f6aa8','#2a3f6e'); ctx.fillStyle='#fff'; ctx.fillRect(o.x+12,o.y+4,o.w-24,o.h-8); }
  }
  function drawCarrot(x,y,w,h){
    ctx.beginPath(); ctx.moveTo(x+w*.15,y); ctx.lineTo(x+w*.85,y); ctx.quadraticCurveTo(x+w*.65,y+h*.60,x+w*.50,y+h); ctx.quadraticCurveTo(x+w*.35,y+h*.60,x+w*.15,y); ctx.closePath();
    ctx.fillStyle='#ff7f50'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#d2653d'; ctx.stroke();
    ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x+w*.25,y+h*.25); ctx.lineTo(x+w*.65,y+h*.25); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x+w*.22,y+h*.45); ctx.lineTo(x+w*.62,y+h*.45); ctx.stroke();
    ctx.fillStyle='#6bcf78'; ctx.beginPath(); ctx.moveTo(x+w*.50,y-6); ctx.quadraticCurveTo(x+w*.25,y-26,x+w*.05,y-8); ctx.quadraticCurveTo(x+w*.55,y-28,x+w*.95,y-8); ctx.fill();
  }
  function drawStar(x,y,w,h){
    const cx=x+w/2, cy=y+h/2, r=Math.min(w,h)/2; ctx.fillStyle='#ffd34f'; ctx.strokeStyle='#caa12e'; ctx.lineWidth=2; ctx.beginPath();
    for(let i=0;i<10;i++){ const ang=Math.PI/5*i-Math.PI/2, rr=(i%2===0)?r:r*.45; const px=cx+Math.cos(ang)*rr, py=cy+Math.sin(ang)*rr; if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); }
    ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.beginPath(); ctx.arc(cx,cy,r*.5,0,Math.PI*2); ctx.fillStyle='rgba(255,221,100,.35)'; ctx.fill();
  }
  function drawHeartItem(x,y,w,h){
    rr(x,y,w,h,10,'#ff6aa5','#c22668'); ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fillRect(x+6,y+6,w-12,4);
  }

  // Spawning
  function phaseConfig(){ return phaseParams[ timePhase(elapsed) ]; }
  function spawnObstacleSet(){
    const p=phaseConfig(); const gY=groundY(); const w=canvas.width;
    const pool=['block','car','van','truck','post','sign','gantry','bus']; // cones/hydrants removed as active hazards
    let type=pool[(Math.random()*pool.length)|0];
    if(Math.random()<p.slideOnly){ type = (Math.random()<.5)? 'gantry':'bus'; }
    const add=o=>obstacles.push(o);
    if(type==='block'){ add({cls:'ground',type:'block',x:w+40,y:gY-50,w:80,h:48}); }
    if(type==='car'){ add({cls:'ground',type:'car',x:w+40,y:gY-54,w:110,h:50}); }
    if(type==='van'){ add({cls:'ground',type:'van',x:w+40,y:gY-64,w:140,h:60}); }
    if(type==='truck'){ add({cls:'ground',type:'truck',x:w+40,y:gY-74,w:200,h:70}); }
    if(type==='post'){ add({cls:'tall_jump',type:'post',x:w+40,y:gY-140,w:40,h:130}); }
    if(type==='sign'){ const spanW=180+Math.random()*80, clearance=SLIDE_H+10, beamY=gY-clearance; add({cls:'slide_optional',type:'sign',x:w+40,y:beamY-12,w:spanW,h:12}); }
    if(type==='gantry'){ const spanW=200+Math.random()*80, clearance=SLIDE_H+8, beamY=gY-clearance; add({cls:'slide_only',type:'gantry',x:w+40,y:beamY-16,w:spanW,h:16}); }
    if(type==='bus'){ const spanW=240+Math.random()*80, clearance=SLIDE_H+6, beamY=gY-clearance; add({cls:'slide_only',type:'bus',x:w+40,y:beamY-18,w:spanW,h:18}); }

    // Carrots
    if(type==='block'||type==='car'||type==='van'||type==='truck') spawnCarrotsAbove(gY-140, 2+((type==='truck')?1:0));
    if(type==='post') spawnCarrotsLine(gY-200,3);
    if(type==='sign') spawnCarrotsTrail(gY,120);
    if(type==='gantry'||type==='bus') spawnCarrotsTrail(gY,160);

    // Items (stars/hearts)
    if(activeEvent?.type==='star_parade'){
      // handled by event spawner
    }else{
      if(Math.random()<STAR_CHANCE && stars.length<2){ const y=gY-(160+Math.random()*100), x=w+260; const s={x,y,w:44,h:44}; stars.push(s); }
      else if(player.hearts<3 && Math.random()<HEART_CHANCE && hearts.length<1){ const y=gY-(150+Math.random()*80), x=w+260; hearts.push({x,y,w:40,h:38}); }
    }

    // Combos
    if(Math.random()<p.combo){
      const dx=120+Math.random()*80;
      add({cls:'ground',type:'block',x:w+40+dx,y:gY-50,w:80,h:48});
    }
  }
  function spawnCarrotsAbove(topY,count){ for(let i=0;i<count;i++) carrotItems.push({x:canvas.width+40+i*40,y:topY-i*10,w:28,h:50}); }
  function spawnCarrotsTrail(gY,w){ for(let i=0;i<3;i++) carrotItems.push({x:canvas.width+40+w+40+i*34,y:gY-100-(i%2)*18,w:28,h:46}); }
  function spawnCarrotsLine(y,count){ for(let i=0;i<count;i++) carrotItems.push({x:canvas.width+40+i*36,y,w:28,h:50}); }

  // Events
  let activeEvent=null, nextEventAt=0, eventBannerTimer=0;
  function scheduleNextEvent(){ nextEventAt = elapsed + 45 + Math.random()*15; }
  function startEvent(type){ activeEvent={type, dur:10, t:0}; eventBannerTimer=1.6;
    banner.style.display='block';
    if(type==='carrot_rush'){ banner.textContent='Carrot Rush!'; banner.style.background='linear-gradient(90deg,#ff9a3c,#ffd34f)'; }
    if(type==='traffic_jam'){ banner.textContent='Traffic Jam!'; banner.style.background='repeating-linear-gradient(45deg,#d44 0 10px,#fff 10px 20px)'; }
    if(type==='star_parade'){ banner.textContent='Star Parade!'; banner.style.background='linear-gradient(90deg,#ff6aa5,#ffd34f,#5bd3ff)'; setMusicMode('star'); }
  }
  function endEvent(){ banner.style.display='none'; activeEvent=null; scheduleNextEvent(); if(musicEnabled && musicMode==='star' && performance.now()>=player.starUntil) setMusicMode('normal'); }

  // Loop
  function loop(t){ const dt=Math.min(.033,(t-last)/1000||0); last=t; const run=(gameState==='running')?dt:0;
    if(gameState==='running'){
      elapsed+=dt; addScore(2*dt);
      // speed ramp
      if(elapsed>0 && Math.floor(elapsed*1000)%SPEED_RAMP_INTERVAL<16){ worldSpeed += SPEED_RAMP_STEP*dt*60; spawnInterval=Math.max(SPAWN_MIN, spawnInterval-20); }
      // spawn cadence
      spawnTimer += dt*1000; if(spawnTimer>=spawnInterval){ spawnTimer=0; spawnObstacleSet(); }
      // events
      if(!activeEvent && elapsed>=nextEventAt){ const r=Math.random(); startEvent(r<.4?'carrot_rush': r<.75?'traffic_jam':'star_parade'); }
      if(activeEvent){ activeEvent.t += dt;
        if(activeEvent.type==='carrot_rush'){ if(Math.random()<.24){ spawnCarrotsLine(groundY()-140,3); } }
        else if(activeEvent.type==='traffic_jam'){ if(Math.random()<.30){ obstacles.push({cls:'ground',type:(Math.random()<.5?'van':'truck'),x:canvas.width+40,y:groundY()-((Math.random()<.5)?64:74),w:(Math.random()<.5?140:200),h:(Math.random()<.5?60:70)}); } }
        else if(activeEvent.type==='star_parade'){ if(Math.random()<.28){ const gY=groundY(); stars.push({x:canvas.width+220,y:gY-(160+Math.random()*100),w:44,h:44}); } }
        if(activeEvent.t>=activeEvent.dur) endEvent();
      }
      if(eventBannerTimer>0){ eventBannerTimer-=dt; if(eventBannerTimer<=0) banner.style.display='none'; }
    }

    // Draw
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBackground(run); drawDecor(run); drawHuckey(run); updateEntities(run); updateParticles(run); drawFloatTexts(run);
    scoreEl.textContent = Math.floor(score).toString();
    requestAnimationFrame(loop);
  } requestAnimationFrame(loop);

  function drawBackground(dt){
    const w=canvas.width; parallax.forEach(L=>{ L.offset -= worldSpeed*L.speed*dt; if(L.offset<=-L.step) L.offset += L.step; for(let x=L.offset; x<w; x+=L.step) ctx.drawImage(L.layer.canvas,Math.floor(x),0); });
    const gy=groundY(); ctx.fillStyle='#8bd17e'; ctx.fillRect(0,gy,w,canvas.height-gy); ctx.fillStyle='#3b3b46'; ctx.fillRect(0,gy-20,w,70);
    drawBackground.roadOffset=(drawBackground.roadOffset||0)-worldSpeed*.8*dt; const dashW=80,gap=40; ctx.fillStyle='#f7f7f7'; for(let x=(drawBackground.roadOffset%(dashW+gap)); x<w; x+=dashW+gap) ctx.fillRect(x,gy+8,dashW,6);
  }

  // Player & particles
  function spawnSparkle(x,y){ particles.push({type:'spark', x,y, vx:-40-Math.random()*60, vy:(Math.random()-.5)*40, life:.5, t:0, hue:Math.floor(Math.random()*360)}); }
  function spawnHeartSpark(x,y){ for(let i=0;i<12;i++){ const ang=Math.random()*Math.PI*2, sp=80+Math.random()*120;
      particles.push({type:'pinkSpark', x,y, vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp, life:.5+Math.random()*.2, t:0}); } }
  function spawnPuff(x,y){ for(let i=0;i<10;i++){ const ang=Math.random()*Math.PI*2, sp=80+Math.random()*120; particles.push({type:'puff',x,y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp*.7,life:.6+Math.random()*.4,t:0}); } if(sfxEnabled) sfx.puff(); }
  function updateParticles(dt){
    for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.t+=dt; if(p.t>p.life){ particles.splice(i,1); continue; }
      p.x+=p.vx*dt; p.y+=p.vy*dt; const a=1-(p.t/p.life);
      if(p.type==='spark'){ ctx.fillStyle=`hsla(${p.hue},90%,60%,${a})`; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill(); }
      else if(p.type==='pinkSpark'){ ctx.fillStyle=`rgba(255,160,200,${a})`; ctx.beginPath(); ctx.arc(p.x,p.y,3.2,0,Math.PI*2); ctx.fill(); ctx.fillStyle=`rgba(255,210,120,${a*.8})`; ctx.beginPath(); ctx.arc(p.x+1,p.y-1,2.2,0,Math.PI*2); ctx.fill(); }
      else if(p.type==='puff'){ ctx.fillStyle=`rgba(200,200,200,${a*.5})`; ctx.beginPath(); ctx.arc(p.x,p.y,8*(1+p.t),0,Math.PI*2); ctx.fill(); }
      else if(p.type==='hudSpark'){ ctx.fillStyle=`rgba(255,180,220,${a})`; ctx.fillRect(p.x+Math.sin(p.t*10),p.y+Math.cos(p.t*10),2,2); }
    }
  }

  function getPlayerHeight(){ return player.sliding ? SLIDE_H : STAND_H; }
  function drawEarPath(x,y,w,h,side,swing,fill,stroke,inner=false){
    const dir=side==='left'?-1:1, sway=swing||0; ctx.beginPath(); ctx.moveTo(x,y);
    ctx.bezierCurveTo(x+dir*(w*.25+sway*10), y+h*.20, x+dir*(w*.45+sway*14), y+h*.65, x+dir*(w*.05+sway*6), y+h);
    ctx.bezierCurveTo(x+dir*(-w*.30+sway*8), y+h*.80, x+dir*(-w*.34+sway*6), y+h*.35, x+dir*(-w*.08+sway*6), y+h*.06); ctx.closePath();
    if(fill){ ctx.fillStyle=fill; ctx.fill(); } if(stroke){ ctx.strokeStyle=stroke; ctx.lineWidth=inner?1.5:2; ctx.stroke(); }
  }
  function drawHuckey(dt){
    const gy=groundY();
    if(!player.onGround){ player.vy+=GRAVITY*dt; player.y+=player.vy*dt; if(player.y+getPlayerHeight()>=gy){ player.y=gy-getPlayerHeight(); player.vy=0; player.onGround=true; player.dJumps=MAX_DOUBLE; } }
    else{ player.y=gy-getPlayerHeight(); }
    player.prevSliding=player.sliding; player.sliding=player.onGround&&player.slideHeld; if(player.sliding&&!player.prevSliding){ if(sfxEnabled) sfx.slide(); }
    if(player.onGround&&!player.sliding&&!player.fainting) player.runPhase += dt*(0.8+worldSpeed/800);
    if(player.fainting) player.faintT += dt;
    const now=performance.now(), starActive=now<player.starUntil, blink=now<player.dmgInvUntil;
    if(starActive){ player.hue=(player.hue+360*dt*2)%360; spawnSparkle(player.x()+40,player.y+40); }
    let visible=true; if(blink && !starActive) visible = Math.floor(now/100)%2===0; if(!visible) return;

    const px=player.x(), ph=getPlayerHeight(), pw=player.width*(player.sliding?1.08:1.0);
    ctx.save(); if(player.fainting){ const t=Math.min(1,player.faintT/.9); ctx.globalAlpha*=(1-t*.35); const rot=t*1.1; ctx.translate(px+pw/2,player.y+ph/2); ctx.rotate(rot); ctx.translate(-(px+pw/2),-(player.y+ph/2)); }
    const pink='#f8a9c9', outline='#d0709a', nose='#d08f8c'; const earBob=(player.onGround&&!player.sliding)? Math.sin(player.runPhase*6)*(ph*.02):0; const earSwing=(player.onGround&&!player.sliding)? Math.sin(player.runPhase*6)*.10:0;
    const bodyColor= starActive? `hsl(${Math.floor(player.hue)},80%,70%)` : pink;
    rr(px+pw*.12,player.y+ph*.26,pw*.52,ph*.56,18,bodyColor,outline); rr(px+pw*.21,player.y+ph*.02,pw*.56,ph*.32,16,bodyColor,outline);
    drawEarPath(px+pw*.24,player.y+ph*.10+earBob,pw*.24,ph*.46,'left',earSwing,bodyColor,outline);
    drawEarPath(px+pw*.70,player.y+ph*.10+earBob,pw*.24,ph*.46,'right',-earSwing,bodyColor,outline);
    drawEarPath(px+pw*.28,player.y+ph*.13+earBob,pw*.18,ph*.40,'left',earSwing,'#ffc1da',null,true);
    drawEarPath(px+pw*.74,player.y+ph*.13+earBob,pw*.18,ph*.40,'right',-earSwing,'#ffc1da',null,true);
    ctx.fillStyle='#333'; ctx.beginPath(); ctx.arc(px+pw*.52,player.y+ph*.14,3.8,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(px+pw*.64,player.y+ph*.14,3.8,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=nose; ctx.beginPath(); ctx.arc(px+pw*.58,player.y+ph*.20,5.2,0,Math.PI*2); ctx.fill();
    rr(px+pw*.22,player.y+ph*.44,pw*.16,ph*.12,10,bodyColor,outline); rr(px+pw*.64,player.y+ph*.44,pw*.16,ph*.12,10,bodyColor,outline);
    const legW=pw*.18, legH=ph*.16, legLx=px+pw*.42-legW*.6, legRx=px+pw*.58-legW*.4; rr(legLx,player.y+ph*.76,legW,legH,12,bodyColor,outline); rr(legRx,player.y+ph*.76,legW,legH,12,bodyColor,outline);
    rr(px+pw*.06,player.y+ph*.60,pw*.12,ph*.12,10,'#ffd1e4',outline);
    if(player.sliding){ ctx.globalAlpha=.08; ctx.fillStyle='#000'; ctx.fillRect(px,player.y+ph*.85,pw*.9,6); }
    ctx.restore();
  }

  // Score text
  function spawnText(x,y,text,color,scale=1){ if(!showPoints) return; floatTexts.push({x,y,t:0,life:.7,text,color,scale}); if(floatTexts.length>3) floatTexts.shift(); }
  function drawFloatTexts(dt){ for(let i=floatTexts.length-1;i>=0;i--){ const f=floatTexts[i]; f.t+=dt; if(f.t>f.life){ floatTexts.splice(i,1); continue; } const a=1-f.t/f.life;
      ctx.save(); ctx.globalAlpha=a*.9; ctx.font=`${Math.floor(18*f.scale)}px Arial`; ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillStyle=f.color; ctx.fillText(f.text,f.x,f.y-f.t*20); ctx.restore(); } }
  function addScore(pts,x=null,y=null,color='#333',scale=1){ score += pts; if(x!=null && y!=null) spawnText(x,y,(pts>0?'+':'')+Math.floor(pts),color,scale); }

  // Entities update
  function playerHit(){ const now=performance.now(); if(now<player.starUntil||now<player.dmgInvUntil||player.fainting||transitioning) return; heartPopEffect(); player.hearts--; updateHearts();
    carrotStreak=0; updateMultUI(); player.dmgInvUntil=now+DMG_INV; if(sfxEnabled) sfx.hit();
    if(player.hearts<=0){ transitioning=true; settingsPanel.style.display='none'; if(gameState==='paused') setPause(false); player.fainting=true; player.faintT=0; if(sfxEnabled) sfx.gameover(); stopAllMusic();
      setTimeout(()=>{ gameState='over'; finalScoreEl.textContent=Math.floor(score).toString(); gameOverCard.style.display='block'; transitioning=false; },900); } }

  function updateEntities(dt){
    // Obstacles
    for(let i=obstacles.length-1;i>=0;i--){ const o=obstacles[i]; o.x -= worldSpeed*dt; drawObstacle(o);
      const pbb={x:player.x(),y:player.y,w:player.width*.9,h:getPlayerHeight()}, now=performance.now(); let collided=false;
      if(o.cls==='slide_only'){ const overlapX=pbb.x<o.x+o.w && pbb.x+pbb.w>o.x; if(overlapX && !player.sliding){ const withinY=pbb.y<o.y+o.h && pbb.y+pbb.h>o.y; if(withinY) collided=true; } }
      else { if(aabb(pbb,o)) collided=true; }
      if(collided){ if(now<player.starUntil){ spawnPuff(pbb.x+pbb.w/2,pbb.y+pbb.h/2); addScore(15*currentMult(),pbb.x+pbb.w/2,pbb.y,'#5bd3ff',1.0); obstacles.splice(i,1); continue; } else if(now>=player.dmgInvUntil){ playerHit(); } }
      if(o.x+o.w<-140) obstacles.splice(i,1);
    }
    // Carrots
    for(let i=carrotItems.length-1;i>=0;i--){ const c=carrotItems[i]; c.x -= worldSpeed*dt; drawCarrot(c.x,c.y,c.w,c.h); const pbb={x:player.x(),y:player.y,w:player.width*.9,h:getPlayerHeight()};
      if(aabb(pbb,c)){ carrotItems.splice(i,1); const before=baseMult(); carrotStreak++; const after=baseMult(); const m=currentMult(); addScore(25*m,c.x+c.w/2,c.y,'#ff8c42',1.0); if(after>before) updateMultUI(true); else updateMultUI(); }
      else if(c.x+c.w<-120) carrotItems.splice(i,1);
    }
    // Stars
    for(let i=stars.length-1;i>=0;i--){ const s=stars[i]; s.x -= worldSpeed*dt; drawStar(s.x,s.y,s.w,s.h); const pbb={x:player.x(),y:player.y,w:player.width*.9,h:getPlayerHeight()};
      if(aabb(pbb,s)){ stars.splice(i,1); player.starUntil=performance.now()+STAR_DURATION; addScore(50,s.x+s.w/2,s.y,'#ffd34f',1.1); if(musicEnabled) setMusicMode('star'); for(let k=0;k<14;k++) spawnSparkle(pbb.x+pbb.w/2,pbb.y+pbb.h*.3); if(sfxEnabled) sfx.star(); updateMultUI(); }
      else if(s.x+s.w<-120) stars.splice(i,1);
    }
    // Hearts
    for(let i=hearts.length-1;i>=0;i--){ const h=hearts[i]; h.x -= worldSpeed*dt; drawHeartItem(h.x,h.y,h.w,h.h); const pbb={x:player.x(),y:player.y,w:player.width*.9,h:getPlayerHeight()};
      if(aabb(pbb,h)){ hearts.splice(i,1); if(player.hearts<3){ player.hearts++; updateHearts(); heartPopEffect(); spawnHeartSpark(pbb.x+pbb.w/2,pbb.y); if(sfxEnabled) sfx.heart(); } }
      else if(h.x+h.w<-120) hearts.splice(i,1);
    }
    // Music swap back after star
    if(musicEnabled && musicMode==='star' && performance.now()>=player.starUntil && (!activeEvent || activeEvent.type!=='star_parade')) setMusicMode('normal');
  }

  // Init state
  player.y=groundY()-player.height; updateHearts(); updateMultUI();
})();</script>
</body>
</html>
