<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Huckey‚Äôs Adventure ‚Äî v13b++</title>
<style>
  html,body{margin:0;height:100%;background:#f3f6fb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;touch-action:manipulation;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}
  #container{position:relative;width:100vw;height:100dvh;overflow:hidden;background:linear-gradient(#cfe7ff,#f6f7fb)}
  canvas{display:block;width:100%;height:100%}
  .ui{position:absolute;inset:0;pointer-events:none;color:#222;text-shadow:0 1px 0 rgba(255,255,255,.6)}
  .hudLeft{position:absolute;left:14px;top:10px;display:flex;align-items:center;gap:8px;font-weight:700}
  .hudRight{position:absolute;right:14px;top:10px;display:flex;gap:8px;align-items:center}
  .score{font-size:18px;padding-left:6px}
  .mult{font-size:14px;padding:2px 6px;border-radius:8px;background:rgba(255,255,255,.7);border:1px solid #d9e4ff}
  .mult.star{box-shadow:0 0 10px rgba(255,215,0,.6)}
  .hearts{display:grid;grid-auto-flow:column;grid-gap:6px}
  .heartSlot{width:26px;height:24px;position:relative}
  .heartFull,.heartEmpty{width:100%;height:100%;display:block}
  .heartEmpty{opacity:.55}
  .heartPop{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;animation:heartPop .65s ease-out forwards}
  @keyframes heartPop{0%{transform:translateY(0) scale(1);opacity:1}40%{transform:translateY(-6px) scale(1.25);opacity:1}100%{transform:translateY(-22px) scale(.65);opacity:0}}
  .titleCard,.gameOverCard{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.94);border-radius:16px;padding:18px 22px;box-shadow:0 8px 24px rgba(0,0,0,.15);text-align:center;pointer-events:auto;max-width:min(92vw,720px)}
  .titleCard h1{margin:0 0 10px 0;font-size:clamp(36px,6vw,64px);color:#ff4f93;line-height:1.05;text-shadow:0 2px 0 rgba(255,255,255,.7)}
  .titleCard .subtitle{margin:0 0 8px 0;color:#4f69a8;font-weight:700}
  .instructions{margin-top:10px;text-align:left;background:#fff;border:1px solid #cfe1ff;border-radius:12px;padding:12px}
  .iRow{display:flex;flex-wrap:wrap;gap:10px;margin:6px 0}
  .iBadge{background:#f4f7ff;border:1px solid #d9e4ff;border-radius:999px;padding:4px 8px;font-weight:700;font-size:13px;display:inline-flex;align-items:center;gap:6px}
  .iEm{font-weight:800;color:#4f6aa8}
  .btn{display:inline-block;margin-top:12px;padding:10px 16px;background:#4f8bff;color:#fff;border-radius:10px;font-weight:700;cursor:pointer;border:none;pointer-events:auto}
  .btn:active{transform:translateY(1px)}
  .settingsBtn{position:absolute;top:10px;left:50%;transform:translateX(-50%);pointer-events:auto;background:#fff;border:1px solid #cfe1ff;border-radius:999px;padding:6px 10px;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,.08);cursor:pointer}
  .settingsPanel{position:absolute;top:42px;left:50%;transform:translateX(-50%);pointer-events:auto;background:rgba(255,255,255,.96);border:1px solid #cfe1ff;border-radius:12px;padding:10px 12px;box-shadow:0 8px 20px rgba(0,0,0,.12);font-size:14px;display:none;min-width:300px}
  .settingsRow{display:flex;align-items:center;gap:10px;margin:6px 0;justify-content:space-between}
  .toggle{appearance:none;width:36px;height:20px;background:#c8d7ff;border-radius:999px;position:relative;outline:none;cursor:pointer}
  .toggle:checked{background:#4f8bff}
  .toggle::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;background:#fff;border-radius:50%;transition:left .15s}
  .toggle:checked::after{left:18px}
  .pauseBadge{position:absolute;left:50%;top:50%;transform:translate(-50%,-120%);background:rgba(0,0,0,.55);color:#fff;padding:6px 10px;border-radius:8px;font-weight:700;display:none}
  .pauseBadge.show{display:block}
  .points{position:absolute;left:0;top:0;pointer-events:none}
</style>
</head>
<body>
<div id="container">
  <canvas id="game"></canvas>
  <div class="ui">
    <div class="hudLeft"><div class="score" id="score">0</div><div class="mult" id="mult">√ó1</div></div>
    <div class="hudRight"><div class="hearts" id="hearts"></div></div>
    <button class="settingsBtn" id="settingsBtn">‚öôÔ∏é Settings / Pause</button>
    <div class="settingsPanel" id="settingsPanel">
      <div class="settingsRow"><label>Music</label><input type="checkbox" id="musicToggle" class="toggle" checked/></div>
      <div class="settingsRow"><label>SFX</label><input type="checkbox" id="sfxToggle" class="toggle" checked/></div>
      <div class="settingsRow"><label>Show +points</label><input type="checkbox" id="pointsToggle" class="toggle" checked/></div>
      <div class="settingsRow"><label>Left/Right swap (mobile)</label><input type="checkbox" id="lrToggle" class="toggle"/></div>
      <div class="settingsRow"><label>Haptics (mobile)</label><input type="checkbox" id="hapticToggle" class="toggle"/></div>
      <div style="font-size:12px;opacity:.8;margin-top:6px">Tap right to hop ‚Ä¢ Hold left to slide</div>
    </div>
    <div class="titleCard" id="title">
      <h1>Huckey‚Äôs Adventure</h1>
      <div class="subtitle">üê∞ v13b++ ‚Ä¢ Endless runner ‚Ä¢ Bunny City</div>
      <div class="instructions">
        <div class="iRow"><span class="iBadge">üñ•Ô∏è <span class="iEm">Desktop</span>: Up/W = Hop (twice = double), Down/S = Slide (hold)</span></div>
        <div class="iRow"><span class="iBadge">üì± <span class="iEm">Mobile</span>: Tap Right = Hop (double-tap = double), Hold Left = Slide</span></div>
        <div class="iRow"><span class="iBadge">ü•ï Carrots</span><span class="iBadge">‚≠ê 10s Invincible + √ó8 points</span><span class="iBadge">‚ù§Ô∏è +1 Heart (max 3)</span></div>
        <div class="iRow"><span class="iBadge">‚ö†Ô∏è Leap small stuff ‚Ä¢ Slide under beams & billboard frames (too tall to hop!)</span></div>
      </div>
      <button class="btn" id="startBtn">Start</button>
    </div>
    <div class="gameOverCard" id="gameOver" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Huckey fainted!</h2>
      <div style="margin:6px 0;">Score: <span id="finalScore">0</span></div>
      <button class="btn" id="restartBtn">Try Again</button>
    </div>
    <div class="pauseBadge" id="pauseBadge"></div>
    <div class="points" id="pointsLayer"></div>
  </div>
</div>
<script>
(()=>{
  const canvas = document.getElementById('game'); const ctx = canvas.getContext('2d');
  function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; } addEventListener('resize',resize); resize();

  // UI
  const heartsEl=document.getElementById('hearts'), scoreEl=document.getElementById('score'), multEl=document.getElementById('mult');
  const titleCard=document.getElementById('title'), startBtn=document.getElementById('startBtn');
  const gameOverCard=document.getElementById('gameOver'), finalScoreEl=document.getElementById('finalScore'), restartBtn=document.getElementById('restartBtn');
  const settingsBtn=document.getElementById('settingsBtn'), settingsPanel=document.getElementById('settingsPanel');
  const musicToggle=document.getElementById('musicToggle'), sfxToggle=document.getElementById('sfxToggle'), pointsToggle=document.getElementById('pointsToggle');
  const lrToggle=document.getElementById('lrToggle'), hapticToggle=document.getElementById('hapticToggle');
  const pauseBadge=document.getElementById('pauseBadge');
  const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

  // Audio (simple)
  let audioCtx=null; let musicEnabled=true, sfxEnabled=true, showPoints=true;
  musicToggle.onchange=()=>{ musicEnabled=musicToggle.checked; };
  sfxToggle.onchange=()=>{ sfxEnabled=sfxToggle.checked; }; pointsToggle.onchange=()=>{ showPoints=pointsToggle.checked; };
  function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
  function envPlay(type, f0, f1, ms, gainMax=0.15){ ensureAudio(); if(!sfxEnabled) return; const t0=audioCtx.currentTime; const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
    o.type=type; o.frequency.setValueAtTime(f0,t0); const t1=t0+ms/1000; if(f1&&f1>0) o.frequency.exponentialRampToValueAtTime(Math.max(20,f1),t1);
    g.gain.setValueAtTime(0.0001,t0); g.gain.exponentialRampToValueAtTime(gainMax,t0+.02); g.gain.exponentialRampToValueAtTime(0.0001,t1); o.connect(g).connect(audioCtx.destination); o.start(t0); o.stop(t1+.02); }
  const sfx={ jump:()=>envPlay('sine',350,1000,160,.10),
              slide:()=>envPlay('sawtooth',800,200,200,.08),
              hit:()=>{ envPlay('square',220,100,200,.12); },
              heart:()=>envPlay('triangle',600,900,180,.12),
              star:()=>envPlay('sine',700,1600,160,.12) };

  // Haptics
  function vibrate(ms){ if(hapticToggle.checked && navigator.vibrate) navigator.vibrate(ms); }

  // Constants (v13b-like)
  const GRAVITY=2200, JUMP_VEL=-900, MAX_DOUBLE=1;
  const BASE_SPEED=360, SPAWN_BASE=1100, SPAWN_MIN=700;
  const STAR_CHANCE=0.06, STAR_DURATION=10000, DMG_INV=1200;
  const STAND_H=100, SLIDE_H=Math.floor(STAND_H*0.62);

  // Heart spawn timing
  let nextHeartAt = null; // seconds
  function scheduleHeart(now){ nextHeartAt = now + (45 + Math.random()*15); } // 45‚Äì60s
  function cooldownHeart(now){ nextHeartAt = now + (20 + Math.random()*10); } // 20‚Äì30s

  // State
  let gameState='title', transitioning=false;
  let last=0, elapsed=0, worldSpeed=BASE_SPEED, spawnTimer=0, spawnInterval=SPAWN_BASE, score=0;
  const obstacles=[], carrotItems=[], stars=[], hearts=[], floatTexts=[];

  // Player
  const player={ x:()=>canvas.width*.2, y:0, vy:0, width:72, height:STAND_H, onGround:false, dJumps:MAX_DOUBLE, hearts:3,
                 starUntil:0, dmgInvUntil:0, slideHeld:false, sliding:false, prevSliding:false, fainting:false, faintT:0, runPhase:0 };
  function groundY(){ return Math.floor(canvas.height*.78); }
  let carrotStreak=0; function baseMult(){ return Math.min(5,1+Math.floor(carrotStreak/5)); }
  function currentMult(){ const m=baseMult(); return (performance.now()<player.starUntil)? Math.min(8,m*2): m; } // √ó8 cap during star
  function updateMultUI(){ multEl.textContent='√ó'+currentMult(); if(performance.now()<player.starUntil) multEl.classList.add('star'); else multEl.classList.remove('star'); }

  // Pause/settings
  function openSettings(){ if(gameState!=='running'||transitioning) return; settingsPanel.style.display='block'; setPause(true); }
  function closeSettings(){ settingsPanel.style.display='none'; setPause(false); }
  settingsBtn.onclick=()=>{ if(gameState==='title'||gameState==='over'||transitioning) return; if(gameState!=='paused') openSettings(); else closeSettings(); };
  addEventListener('keydown',e=>{
    if(e.key==='p'||e.key==='P'){ if(transitioning||gameState==='title'||gameState==='over') return; if(gameState!=='paused') openSettings(); else closeSettings(); return; }
    if(gameState!=='running'||transitioning) return;
    if(e.key==='ArrowUp'||e.key==='w'||e.key===' '||e.key==='j'||e.key==='J'){ jump(); }
    if(e.key==='ArrowDown'||e.key==='s'||e.key==='k'||e.key==='K'){ player.slideHeld=true; sfx.slide(); vibrate(10); }
  });
  addEventListener('keyup',e=>{ if(e.key==='ArrowDown'||e.key==='s'||e.key==='k'||e.key==='K') player.slideHeld=false; });

  // Invisible mobile tap zones
  function touchSide(t){ return (lrToggle.checked? -1:1) * (t.clientX - innerWidth/2) >= 0 ? 'right':'left'; }
  function onTouchStart(ev){ if(gameState!=='running'||transitioning) return; const t=(ev.changedTouches?ev.changedTouches[0]:ev); const side=touchSide(t);
    if(side==='right'){ jump(); }
    else{ player.slideHeld=true; sfx.slide(); vibrate(10); }
    ev.preventDefault();
  }
  function onTouchEnd(ev){ if(gameState!=='running'||transitioning) return; const t=(ev.changedTouches?ev.changedTouches[0]:ev); const side=touchSide(t);
    if(side==='left'){ player.slideHeld=false; } ev.preventDefault();
  }
  canvas.addEventListener('touchstart',onTouchStart,{passive:false}); canvas.addEventListener('touchend',onTouchEnd,{passive:false});
  canvas.addEventListener('mousedown',onTouchStart); canvas.addEventListener('mouseup',onTouchEnd);

  // Hearts HUD
  function heartSVG(full=true){
    if(full) return `<svg class="heartFull" viewBox="0 0 64 60" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#ff6aa5"/><stop offset="100%" stop-color="#ff3d88"/></linearGradient></defs><path d="M32 56 C 12 40, 4 30, 4 20 C 4 10, 12 4, 20 4 C 26 4, 30 7, 32 11 C 34 7, 38 4, 44 4 C 52 4, 60 10, 60 20 C 60 30, 52 40, 32 56 Z" fill="url(#g)" stroke="#c22668" stroke-width="3"/><path d="M22 12 C 18 10, 14 12, 13 16" fill="none" stroke="rgba(255,255,255,.7)" stroke-width="4" stroke-linecap="round"/><path d="M33 49 C 30 52, 28 53, 26 54" fill="none" stroke="rgba(0,0,0,.08)" stroke-width="4" stroke-linecap="round"/></svg>`;
    return `<svg class="heartEmpty" viewBox="0 0 64 60" xmlns="http://www.w3.org/2000/svg"><path d="M32 56 C 12 40, 4 30, 4 20 C 4 10, 12 4, 20 4 C 26 4, 30 7, 32 11 C 34 7, 38 4, 44 4 C 52 4, 60 10, 60 20 C 60 30, 52 40, 32 56 Z" fill="rgba(255,255,255,.12)" stroke="#9aa1aa" stroke-width="3"/></svg>`;
  }
  function updateHearts(){ heartsEl.innerHTML=''; for(let i=0;i<3;i++){ const slot=document.createElement('div'); slot.className='heartSlot'; const isFull=i<player.hearts; slot.innerHTML=heartSVG(isFull); heartsEl.appendChild(slot);} }
  function heartPopEffect(){ const idx=Math.max(0,player.hearts-1); const slot=heartsEl.children[idx]; if(!slot) return; const pop=document.createElement('div'); pop.className='heartPop'; pop.innerHTML=heartSVG(true); slot.appendChild(pop);
    setTimeout(()=>{ if(pop.parentNode) pop.parentNode.removeChild(pop); },700);
  }

  // Game control
  function resetGame(){
    obstacles.length=carrotItems.length=stars.length=hearts.length=floatTexts.length=0;
    worldSpeed=BASE_SPEED; spawnInterval=SPAWN_BASE; spawnTimer=0; elapsed=0; score=0; carrotStreak=0; nextHeartAt=null;
    player.y=groundY()-player.height; player.vy=0; player.onGround=true; player.dJumps=MAX_DOUBLE; player.hearts=3; player.starUntil=0; player.dmgInvUntil=0;
    player.slideHeld=false; player.sliding=false; player.prevSliding=false; player.fainting=false; player.faintT=0; player.runPhase=0; transitioning=false;
    updateHearts(); scoreEl.textContent='0'; updateMultUI(); settingsPanel.style.display='none'; pauseBadge.classList.remove('show');
  }
  function startGame(){ resetGame(); titleCard.style.display='none'; gameOverCard.style.display='none'; gameState='running'; }
  startBtn.onclick=startGame; restartBtn.onclick=startGame;

  function jump(){ if(player.fainting||transitioning) return; if(!sfxEnabled){} else sfx.jump(); vibrate(8);
    if(player.onGround){ player.vy=JUMP_VEL; player.onGround=false; player.dJumps=MAX_DOUBLE; }
    else if(player.dJumps>0){ player.vy=JUMP_VEL*.92; player.dJumps--; }
  }

  // Helpers
  function aabb(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
  function rr(x,y,w,h,r,fill,stroke){ const R=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+R,y); ctx.arcTo(x+w,y,x+w,y+h,R); ctx.arcTo(x+w,y+h,x,y+h,R); ctx.arcTo(x,y+h,x,y,R); ctx.arcTo(x,y,x+w,y,R);
    if(fill){ ctx.fillStyle=fill; ctx.fill(); } if(stroke){ ctx.strokeStyle=stroke; ctx.lineWidth=2; ctx.stroke(); } }

  // Background
  const parallax=[]; function makeLayer(tileW,color,bYf,hF,step,winAlpha){ const off=document.createElement('canvas'); off.width=tileW; off.height=1000; const o=off.getContext('2d'); const h=off.height;
    const baseY=Math.floor(h*bYf), layerH=Math.floor(h*hF), cols=Math.floor(tileW/step);
    for(let i=0;i<cols;i++){ const x=i*step+10, bw=step-20, t=(i*37)%97, bh=Math.floor(layerH*(0.55+(t%10)/50));
      o.fillStyle=color; o.fillRect(x,baseY-bh,bw,bh); o.fillStyle=`rgba(255,255,255,${winAlpha})`; for(let wx=6;wx<bw;wx+=18){ for(let wy=6;wy<bh;wy+=18){ o.fillRect(x+wx,baseY-bh+wy,8,8); } } }
    return {canvas:off, baseY}; }
  function initParallax(){ parallax.length=0; const w=800;
    parallax.push({speed:.18, layer:makeLayer(w,'#b7d2ff',.62,.25,200,.12), step:w, offset:0});
    parallax.push({speed:.36, layer:makeLayer(w,'#98c0ff',.68,.28,180,.14), step:w, offset:0});
    parallax.push({speed:.58, layer:makeLayer(w,'#7fb0ff',.74,.32,160,.16), step:w, offset:0}); }
  initParallax(); addEventListener('resize',initParallax);

  function drawBackground(dt){
    const w=canvas.width; parallax.forEach(L=>{ L.offset -= worldSpeed*L.speed*dt; if(L.offset<=-L.step) L.offset += L.step; for(let x=L.offset; x<w; x+=L.step) ctx.drawImage(L.layer.canvas,Math.floor(x),0); });
    const gy=groundY(); ctx.fillStyle='#8bd17e'; ctx.fillRect(0,gy,w,canvas.height-gy); ctx.fillStyle='#3b3b46'; ctx.fillRect(0,gy-20,w,70);
    drawBackground.roadOffset=(drawBackground.roadOffset||0)-worldSpeed*.8*dt; const dashW=80,gap=40; ctx.fillStyle='#f7f7f7'; for(let x=(drawBackground.roadOffset%(dashW+gap)); x<w; x+=dashW+gap) ctx.fillRect(x,gy+8,dashW,6);
  }

  // Huckey (v13b-ish)
  function getPlayerHeight(){ return player.sliding ? SLIDE_H : STAND_H; }
  function drawHuckey(dt){
    const gy=groundY();
    if(!player.onGround){ player.vy+=GRAVITY*dt; player.y+=player.vy*dt; if(player.y+getPlayerHeight()>=gy){ player.y=gy-getPlayerHeight(); player.vy=0; player.onGround=true; player.dJumps=MAX_DOUBLE; } }
    else{ player.y=gy-getPlayerHeight(); }
    player.prevSliding=player.sliding; player.sliding=player.onGround&&player.slideHeld; if(player.sliding&&!player.prevSliding) sfx.slide();
    if(player.onGround&&!player.sliding&&!player.fainting) player.runPhase += dt*(0.8+worldSpeed/800);

    const now=performance.now(), starActive=now<player.starUntil, blink=now<player.dmgInvUntil;
    if(blink && !starActive){ if(Math.floor(now/100)%2===0) return; }
    const px=player.x(), ph=getPlayerHeight(), pw=player.width*(player.sliding?1.08:1.0);
    const pink='#f8a9c9', outline='#d0709a', bodyColor= starActive? `hsl(${Math.floor((now/20)%360)},80%,70%)` : pink;
    // body
    rr(px+pw*.15,player.y+ph*.26,pw*.54,ph*.56,18,bodyColor,outline); rr(px+pw*.22,player.y+ph*.04,pw*.54,ph*.30,16,bodyColor,outline);
    // ears (wider)
    const earBob=(player.onGround&&!player.sliding)? Math.sin(player.runPhase*6)*(ph*.02):0;
    rr(px+pw*.20,player.y+ph*.10+earBob,pw*.22,ph*.48,14,bodyColor,outline);
    rr(px+pw*.66,player.y+ph*.10+earBob,pw*.22,ph*.48,14,bodyColor,outline);
    // face
    ctx.fillStyle='#333'; ctx.beginPath(); ctx.arc(px+pw*.52,player.y+ph*.14,3.6,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(px+pw*.64,player.y+ph*.14,3.6,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#d08f8c'; ctx.beginPath(); ctx.arc(px+pw*.58,player.y+ph*.20,5.2,0,Math.PI*2); ctx.fill();
    // limbs & tail
    rr(px+pw*.24,player.y+ph*.46,pw*.14,ph*.10,10,bodyColor,outline); rr(px+pw*.62,player.y+ph*.46,pw*.14,ph*.10,10,bodyColor,outline);
    rr(px+pw*.40,player.y+ph*.76,pw*.18,ph*.16,12,bodyColor,outline); rr(px+pw*.58,player.y+ph*.76,pw*.18,ph*.16,12,bodyColor,outline);
    rr(px+pw*.06,player.y+ph*.60,pw*.12,ph*.12,10,'#ffd1e4',outline);
  }

  // Obstacles (v13b-like + new billboard frame)
  function drawObstacle(o){
    if(o.type==='block'){ rr(o.x,o.y,o.w,o.h,10,'#5e7fd8','#2c49a4'); }
    if(o.type==='car'){ rr(o.x,o.y,o.w,o.h,10,'#6aa5ff','#2b5bb8'); }
    if(o.type==='van'){ rr(o.x,o.y,o.w,o.h,10,'#7eafff','#2b5bb8'); }
    if(o.type==='truck'){ rr(o.x,o.y,o.w,o.h,10,'#6aa5ff','#2b5bb8'); }
    if(o.type==='beam'){ rr(o.x,o.y,o.w,o.h,8,'#ffd34f','#caa12e'); }
    if(o.type==='billboard'){
      // top panel
      rr(o.x,o.y,o.w,o.hTop,10,'#ff9a3c','#c66f20');
      // posts
      rr(o.x, o.y+o.hTop, 16, o.hPost, 6, '#8a7cff','#5a49cc');
      rr(o.x+o.w-16, o.y+o.hTop, 16, o.hPost, 6, '#8a7cff','#5a49cc');
      // subtle shadow under the gap
      const gy = o.y+o.hTop+o.hPost;
      ctx.fillStyle='rgba(0,0,0,.08)'; ctx.fillRect(o.x+20, gy-6, o.w-40, 6);
    }
  }

  // Items
  function drawCarrot(x,y,w,h){
    ctx.beginPath(); ctx.moveTo(x+w*.15,y); ctx.lineTo(x+w*.85,y); ctx.quadraticCurveTo(x+w*.65,y+h*.60,x+w*.50,y+h); ctx.quadraticCurveTo(x+w*.35,y+h*.60,x+w*.15,y); ctx.closePath();
    ctx.fillStyle='#ff7f50'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#d2653d'; ctx.stroke();
    ctx.fillStyle='#6bcf78'; ctx.beginPath(); ctx.moveTo(x+w*.50,y-6); ctx.quadraticCurveTo(x+w*.25,y-26,x+w*.05,y-8); ctx.quadraticCurveTo(x+w*.55,y-28,x+w*.95,y-8); ctx.fill();
  }
  function drawStar(x,y,w,h){
    const cx=x+w/2, cy=y+h/2, r=Math.min(w,h)/2; ctx.fillStyle='#ffd34f'; ctx.strokeStyle='#caa12e'; ctx.lineWidth=2; ctx.beginPath();
    for(let i=0;i<10;i++){ const ang=Math.PI/5*i-Math.PI/2, rr=(i%2===0)?r:r*.45; const px=cx+Math.cos(ang)*rr, py=cy+Math.sin(ang)*rr; if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); } ctx.closePath(); ctx.fill(); ctx.stroke();
  }
  function drawHeartItem(x,y,w,h){ rr(x,y,w,h,10,'#ff6aa5','#c22668'); ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fillRect(x+6,y+6,w-12,4); }

  // Spawning
  function spawnObstacleSet(){
    const gY=groundY(); const w=canvas.width; const pool=['block','car','van','truck','beam','billboard'];
    const type=pool[(Math.random()*pool.length)|0];
    const add=o=>obstacles.push(o);
    if(type==='block'){ add({type:'block',x:w+40,y:gY-50,w:80,h:48}); }
    if(type==='car'){ add({type:'car',x:w+40,y:gY-54,w:110,h:50}); }
    if(type==='van'){ add({type:'van',x:w+40,y:gY-64,w:140,h:60}); }
    if(type==='truck'){ add({type:'truck',x:w+40,y:gY-74,w:200,h:70}); }
    if(type==='beam'){ const spanW=200+Math.random()*120, clearance=SLIDE_H+6, beamY=gY-clearance; add({type:'beam',x:w+40,y:beamY-18,w:spanW,h:18,slideOnly:true}); }
    if(type==='billboard'){ const gapH=SLIDE_H-4, topH=40, postH= (gY-(gY-gapH-topH))-topH; add({type:'billboard',x:w+40,y:gY-gapH-topH-postH,w:220+Math.random()*120,hTop:topH,hPost:postH,slideOnly:true}); }
    // Carrots
    if(type==='block'||type==='car'||type==='van'||type==='truck'){ for(let i=0;i<3;i++) carrotItems.push({x:w+40+i*40,y:gY-140-i*10,w:28,h:50}); }
    if(type==='beam' || type==='billboard'){ for(let i=0;i<3;i++) carrotItems.push({x:w+40+200+i*34,y:gY-100-(i%2)*18,w:28,h:46}); }

    // Stars ‚Äî occasional, avoid overlap with hearts by staggering timing
    if(Math.random()<STAR_CHANCE && stars.length<2){ const y=gY-(160+Math.random()*100), x=w+260; stars.push({x,y,w:44,h:44}); }

    // Hearts ‚Äî time-gated
    if(player.hearts<3){
      if(nextHeartAt===null) scheduleHeart(elapsed);
      if(elapsed>=nextHeartAt && hearts.length<1){ const y=gY-(150+Math.random()*80), x=w+260; hearts.push({x,y,w:40,h:38}); scheduleHeart(elapsed); }
    }
    // occasional double combo
    if(Math.random()<0.12){ const dx=120+Math.random()*80; add({type:'block',x:w+40+dx,y:gY-50,w:80,h:48}); }
  }

  // Loop
  function loop(t){ const dt=Math.min(.033,(t-last)/1000||0); last=t; const run=(gameState==='running')?dt:0;
    if(gameState==='running'){
      elapsed+=dt; addScore(2*dt);
      spawnTimer += dt*1000; if(spawnTimer>=spawnInterval){ spawnTimer=0; spawnInterval=Math.max(SPAWN_MIN, spawnInterval-10); spawnObstacleSet(); }
    }
    // Draw
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBackground(run); drawHuckey(run); updateEntities(run); drawFloatTexts(run);
    scoreEl.textContent = Math.floor(score).toString();
    requestAnimationFrame(loop);
  } requestAnimationFrame(loop);

  // Entities & collisions
  function getBB(){ return {x:player.x(),y:player.y,w:player.width*.9,h:getPlayerHeight()}; }
  function updateEntities(dt){
    // Obstacles
    for(let i=obstacles.length-1;i>=0;i--){ const o=obstacles[i]; o.x -= worldSpeed*dt; drawObstacle(o);
      let collided=false; const pbb=getBB();
      if(o.slideOnly){ const overlapX=pbb.x<o.x+o.w && pbb.x+pbb.w>o.x; if(overlapX && !player.sliding){ const withinY=pbb.y<o.y+o.h && pbb.y+pbb.h>o.y; if(withinY) collided=true; } }
      else { if(aabb(pbb,o)) collided=true; }
      if(collided){ const now=performance.now(); if(now<player.starUntil){ addScore(15*currentMult(),pbb.x+pbb.w/2,pbb.y,'#5bd3ff',1.0); obstacles.splice(i,1); continue; }
                    if(now>=player.dmgInvUntil){ playerHit(); } }
      if(o.x+o.w<-140) obstacles.splice(i,1);
    }
    // Carrots
    for(let i=carrotItems.length-1;i>=0;i--){ const c=carrotItems[i]; c.x -= worldSpeed*dt; drawCarrot(c.x,c.y,c.w,c.h); if(aabb(getBB(),c)){ carrotItems.splice(i,1); const before=baseMult(); carrotStreak++; const after=baseMult(); addScore(25*currentMult(),c.x+c.w/2,c.y,'#ff8c42',1.0); updateMultUI(); } else if(c.x+c.w<-120) carrotItems.splice(i,1); }
    // Stars
    for(let i=stars.length-1;i>=0;i--){ const s=stars[i]; s.x -= worldSpeed*dt; drawStar(s.x,s.y,s.w,s.h); if(aabb(getBB(),s)){ stars.splice(i,1); player.starUntil=performance.now()+STAR_DURATION; addScore(50,s.x+s.w/2,s.y,'#ffd34f',1.1); sfx.star(); updateMultUI(); } else if(s.x+s.w<-120) stars.splice(i,1); }
    // Hearts
    for(let i=hearts.length-1;i>=0;i--){ const h=hearts[i]; h.x -= worldSpeed*dt; drawHeartItem(h.x,h.y,h.w,h.h); if(aabb(getBB(),h)){ hearts.splice(i,1); if(player.hearts<3){ player.hearts++; updateHearts(); heartPopEffect(); sfx.heart(); cooldownHeart(elapsed); } } else if(h.x+h.w<-120) hearts.splice(i,1); }
  }

  // Score text
  function spawnText(x,y,text,color,scale=1){ if(!showPoints) return; floatTexts.push({x,y,t:0,life:.7,text,color,scale}); if(floatTexts.length>3) floatTexts.shift(); }
  function drawFloatTexts(dt){ for(let i=floatTexts.length-1;i>=0;i--){ const f=floatTexts[i]; f.t+=dt; if(f.t>f.life){ floatTexts.splice(i,1); continue; } const a=1-f.t/f.life;
      ctx.save(); ctx.globalAlpha=a*.9; ctx.font=`${Math.floor(18*f.scale)}px Arial`; ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillStyle=f.color; ctx.fillText(f.text,f.x,f.y-f.t*20); ctx.restore(); } }
  function addScore(pts,x=null,y=null,color='#333',scale=1){ score += pts; if(x!=null && y!=null) spawnText(x,y,(pts>0?'+':'')+Math.floor(pts),color,scale); }

  // Damage & game over
  function playerHit(){ const now=performance.now(); if(now<player.starUntil||now<player.dmgInvUntil||player.fainting||transitioning) return; heartPopEffect(); player.hearts--; updateHearts();
    carrotStreak=0; updateMultUI(); player.dmgInvUntil=now+DMG_INV; sfx.hit();
    if(player.hearts<=0){ transitioning=true; if(gameState==='paused') setPause(false); player.fainting=true;
      setTimeout(()=>{ gameState='over'; finalScoreEl.textContent=Math.floor(score).toString(); gameOverCard.style.display='block'; transitioning=false; },800); } }

  // Pause
  function setPause(v){ if(v){ if(gameState==='running'){ gameState='paused'; pauseBadge.classList.add('show'); pauseBadge.textContent=isMobile?'Paused':'Paused ‚Äî Press P to resume'; } }
                        else{ if(gameState==='paused'){ gameState='running'; pauseBadge.classList.remove('show'); } } }

  // Init
  player.y=groundY()-player.height; updateHearts(); updateMultUI();
})();</script>
</body>
</html>
